I"·Q<p>Once upon time programming language researchers used to debate whether programming
languages should be lexically or dynamically scoped. That might sound like gibberish to you
but I think thereâ€™s an important lesson about modern software engineering
to be learnt here, so allow me to explain.</p>

<h2 id="scoping-lexical-or-dynamic">Scoping: lexical or dynamic?</h2>
<p>The question of lexical or dynamic scoping essentially boils down to this:
what will <code class="highlighter-rouge">greet()</code> print?</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello!</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">printGreeting</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">greeting</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">greet</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Fuck off!</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">printGreeting</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>The name <code class="highlighter-rouge">greeting</code> is not defined inside the function <code class="highlighter-rouge">printGreeting</code>, so
we have to look into the outside environment to determine its value.</p>
<ul>
  <li>In a lexically scoped language we will look into the environment in which <code class="highlighter-rouge">printGreeting</code>
is defined and see that <code class="highlighter-rouge">greeting</code> has been assigned the value <code class="highlighter-rouge">"Hello!"</code>.</li>
  <li>In a dynamically scoped language we will look into the environment in which <code class="highlighter-rouge">printGreeting</code>
is executing and see that <code class="highlighter-rouge">greeting</code> has been assigned the value <code class="highlighter-rouge">"Fuck off!"</code>.</li>
</ul>

<p>If dynamic scoping seems very weird to you, it likely is partly because youâ€™ve never seen it before,
and partly because it actually is very weird. Almost all modern programming languages are lexically
scoped. Dynamic scoping makes it hard to figure what our program actually does, without executing it,
and thatâ€™s not a quality we want our programs to exhibit.</p>

<p>Dynamic scoping might seem dubious at first glance, but Iâ€™m going to argue that one of the biggest
advances in software engineering these past 20 years<sup id="fnref:debatable"><a href="#fn:debatable" class="footnote">1</a></sup> essentially boils down emulating dynamic scoping
in lexically scoped languages. Iâ€™m talking about dependency injection.</p>

<h2 id="dependency-injection">Dependency injection</h2>
<p>Letâ€™s switch example language to java.</p>

<p>Consider the following piece of hypothetical code which handles an order in a web shop:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Supply</span><span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
        <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
    <span class="nc">Mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Our <code class="highlighter-rouge">acceptOrder</code> function above has some problems when it comes to testability.
We simply cannot call it without incurring severe side effects on the outside world;
charging money and sending mails are not stuff we want to do in test.</p>

<p>Commonly accepted wisdom tells us that the above problem can be solved by
introducing objects and accepting our dependencies in the constructor:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SupplyService</span> <span class="n">supply</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BankService</span> <span class="n">bank</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MailService</span> <span class="n">mailer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OrderService</span><span class="o">(</span>
        <span class="nc">SupplyService</span> <span class="n">supply</span><span class="o">,</span>
        <span class="nc">BankService</span> <span class="n">bank</span><span class="o">,</span>
        <span class="nc">MailService</span> <span class="n">mailer</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">supply</span> <span class="o">=</span> <span class="n">supply</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mailer</span> <span class="o">=</span> <span class="n">mailer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">supply</span><span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
            <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
        <span class="n">mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now two things have happened.</p>

<p>First of all, our code got much longer. However, 
this is mostly Javaâ€™s fault and not something inherently wrong with objects 
and dependency injection.</p>

<p>Second, we can now pass in different implementations 
of our dependencies when executing in test. This is very good, but let me rephrase
that in more general terms: the value of certain names are now dependent on the environment
in which we are executing. This should sound very familiar,
dependency injection is just dynamic binding in disguise.</p>

<h2 id="dependency-injection-is-not-trivial">Dependency injection is not trivial</h2>
<p>The problem with objects is that they have to be constructed somewhere. To
build an <code class="highlighter-rouge">OrderService</code> we also need to build a <code class="highlighter-rouge">StockService</code>, and whatever
that <code class="highlighter-rouge">StockService</code> depend upon and so forth. This can easily turn into a huge
hassle where shared dependencies lead to code duplication and just thinking of
having to add a new dependency to an object makes you groan in annoyance.</p>

<p>One solution to this problem is to write a factory to construct our objects for us.
This can remove all code duplication which makes changing dependencies easy again,
but it still leads to lots of brain dead code that weâ€™d rather not write. In practice many
organizations end up forgoing their factories in favor of more dynamic dependency
injection frameworks that construct objects using reflection, like Spring or Guice.</p>

<h2 id="reader-monads">Reader monads</h2>
<p>One alternative way to solve the testability problem would be to introduce a 
container for all things we want to change when testing:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Env</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">SupplyService</span> <span class="n">supply</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">BankService</span> <span class="n">bank</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">MailerService</span> <span class="n">mailer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Env</span><span class="o">(</span>
        <span class="nc">SupplyService</span> <span class="n">supply</span><span class="o">,</span>
        <span class="nc">BankService</span> <span class="n">bank</span><span class="o">,</span>
        <span class="nc">MailService</span> <span class="n">mailer</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">supply</span> <span class="o">=</span> <span class="n">supply</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mailer</span> <span class="o">=</span> <span class="n">mailer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Env</span> <span class="n">env</span><span class="o">,</span> <span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">env</span><span class="o">.</span><span class="na">supply</span><span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
        <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">env</span><span class="o">.</span><span class="na">bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Now we only had to construct objects for those services that we want to change
when testing. In this small example it didnâ€™t have much effect on the code size
but in a large project it could remove a lot of useless objects. If we preferred to, we could also put
regular function references in the <code class="highlighter-rouge">Env</code>, instead of service objects.
Finally, we could also remove the <code class="highlighter-rouge">Env</code> entirely and pass around the services one by one, but
this quickly leads to an unmaintainable mess.</p>

<p>Here we are looking up names in an environment which we got passed to us by our caller.
It should be even more obvious than with dependency injection that this is just dynamic scoping in disguise.</p>

<p>The problem with this style of programming is of course that we have to pass the <code class="highlighter-rouge">Env</code> around everywhere.
However, some programming languages â€“like Haskellâ€“ has syntactic sugar that lets us implicitly pass
the <code class="highlighter-rouge">Env</code> around: this is called using a reader monad.</p>

<h2 id="explicit-dynamic-scoping">Explicit dynamic scoping</h2>
<p>Some lexically scoped programming languages, like Perl and most Lisps, allow us to explicitly
declare that a certain name should be dynamically scoped. Letâ€™s explore how that would be done
in Clojure.</p>

<p>First letâ€™s define a dangerous function that we donâ€™t want called in test:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">myproject.lib</span><span class="p">)</span><span class="w">

</span><span class="c1">; This defines send-nukes as dynamically scoped.</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="o">^</span><span class="no">:dynamic</span><span class="w"> </span><span class="n">send-nukes</span><span class="w">
  </span><span class="s">"Performs some side effect on the outside world. Should not be called in test."</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"This was bad. Really bad."</span><span class="p">))</span></code></pre></figure>

<p>Then letâ€™s use it in two different ways:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">myproject.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">myproject.lib</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">lib</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">do-stuff</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
  </span><span class="c1">; Do dangerous stuff</span><span class="w">
  </span><span class="p">(</span><span class="nf">lib/send-nukes</span><span class="p">)</span><span class="w">
  </span><span class="c1">; Return a value</span><span class="w">
  </span><span class="n">x</span><span class="p">)</span><span class="w">

</span><span class="c1">; Normal usage, prints "This was bad. Really bad."</span><span class="w">
</span><span class="p">(</span><span class="nf">do-stuff</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="c1">; Safe testing, prints "No problem"</span><span class="w">
</span><span class="p">(</span><span class="nb">binding</span><span class="w"> </span><span class="p">[</span><span class="n">lib/send-nukes</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"No problem"</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-stuff</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span></code></pre></figure>

<p>In my opinion this style of dependency injection is the simplest one<sup id="fnref:gotcha"><a href="#fn:gotcha" class="footnote">2</a></sup>. 
Itâ€™s a shame that it isnâ€™t available in more languages.</p>

<div class="footnotes">
  <ol>
    <li id="fn:debatable">
      <p>DebatableÂ <a href="#fnref:debatable" class="reversefootnote">â¤´</a></p>
    </li>
    <li id="fn:gotcha">
      <p>GotchaÂ <a href="#fnref:gotcha" class="reversefootnote">â¤´</a></p>
    </li>
  </ol>
</div>
:ET