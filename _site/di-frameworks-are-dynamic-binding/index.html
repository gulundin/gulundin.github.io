<!DOCTYPE html>
<html>
  <head>
    <title>Dependency injection is dynamic scoping in disguise – Dynamic Stability – Thoughts about maintainable programming</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Once upon time programming language researchers used to debate whether programming
languages should be lexically or dynamically scoped. That might sound like gibberish to you
but I think there’s an important lesson about modern software engineering
to be learnt here, so allow me to explain.
" />
    <meta property="og:description" content="Once upon time programming language researchers used to debate whether programming
languages should be lexically or dynamically scoped. That might sound like gibberish to you
but I think there’s an important lesson about modern software engineering
to be learnt here, so allow me to explain.
" />
    
    <meta name="author" content="Dynamic Stability" />

    
    <meta property="og:title" content="Dependency injection is dynamic scoping in disguise" />
    <meta property="twitter:title" content="Dependency injection is dynamic scoping in disguise" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Dynamic Stability - Thoughts about maintainable programming" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Dynamic Stability</a></h1>
            <p class="site-description">Thoughts about maintainable programming</p>
          </div>

          <nav>
            <a href="/">Home</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Dependency injection is dynamic scoping in disguise</h1>

  <div class="entry">
    <p>Once upon time programming language researchers used to debate whether programming
languages should be lexically or dynamically scoped. That might sound like gibberish to you
but I think there’s an important lesson about modern software engineering
to be learnt here, so allow me to explain.</p>

<h2 id="scoping-lexical-or-dynamic">Scoping: lexical or dynamic?</h2>
<p>The question of lexical or dynamic scoping essentially boils down to this:
what will <code class="highlighter-rouge">greet()</code> print?</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello!</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">printGreeting</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">greeting</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">greet</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Fuck off!</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">printGreeting</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>The name <code class="highlighter-rouge">greeting</code> is not defined inside the function <code class="highlighter-rouge">printGreeting</code>, so
we have to look into the outside environment to determine its value.</p>
<ul>
  <li>In a lexically scoped language we will look into the environment in which <code class="highlighter-rouge">printGreeting</code>
is defined and see that <code class="highlighter-rouge">greeting</code> has been assigned the value <code class="highlighter-rouge">"Hello!"</code>.</li>
  <li>In a dynamically scoped language we will look into the environment in which <code class="highlighter-rouge">printGreeting</code>
is executing and see that <code class="highlighter-rouge">greeting</code> has been assigned the value <code class="highlighter-rouge">"Fuck off!"</code>.</li>
</ul>

<p>If dynamic scoping seems very weird to you, it is likely partly because you’ve never seen it before,
and partly because it actually is very weird. Almost all modern programming languages are lexically
scoped. Dynamic scoping makes it hard to determine what our program will actually do without executing it,
and that’s not a quality we want our programs to exhibit.</p>

<p>Dynamic scoping might seem dubious at first glance, but I’m going to argue that one of the biggest
advances in software engineering these past 15 years essentially boils down emulating dynamic scoping
in lexically scoped languages. I’m talking about dependency injection.</p>

<h2 id="dependency-injection">Dependency injection</h2>
<p>Let’s switch example language to java.</p>

<p>Consider the following piece of hypothetical code which handles an order in a web shop:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Stock</span><span class="o">.</span><span class="na">reduceSupply</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
        <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
    <span class="nc">Mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Our <code class="highlighter-rouge">acceptOrder</code> function above has some problems when it comes to testability.
We simply cannot call it without incurring severe side effects on the outside world;
charging money and sending mails are not stuff we want to do in test.</p>

<p>Commonly accepted wisdom tells us that the above problem can be solved by
introducing objects and accepting our dependencies in the constructor:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StockService</span> <span class="n">stock</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BankService</span> <span class="n">bank</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MailService</span> <span class="n">mailer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OrderService</span><span class="o">(</span>
        <span class="nc">StockService</span> <span class="n">stock</span><span class="o">,</span>
        <span class="nc">BankService</span> <span class="n">bank</span><span class="o">,</span>
        <span class="nc">MailService</span> <span class="n">mailer</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stock</span> <span class="o">=</span> <span class="n">stock</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mailer</span> <span class="o">=</span> <span class="n">mailer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stock</span><span class="o">.</span><span class="na">reduceSupply</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
            <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
        <span class="n">mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now two things have happened.</p>

<p>First of all, our code got much longer. However, 
this is mostly Java’s fault and not something inherently wrong with objects 
and dependency injection.</p>

<p>Second, we can now pass in different implementations 
of our dependencies when executing in test. This is very good, but let me rephrase
that in more general terms: we can now look into the environment in which we are
executing to determine the value of names. This should sound very familiar,
dependency injection is just dynamic binding in disguise.</p>

<h2 id="dependency-injection-is-not-trivial">Dependency injection is not trivial</h2>
<p>The problem with objects is that they have to be constructed somewhere. To
build an <code class="highlighter-rouge">OrderService</code> we also need to build a <code class="highlighter-rouge">StockService</code>, and whatever
that <code class="highlighter-rouge">StockService</code> depend upon and so forth. This can easily turn into a huge
hassle where shared dependencies lead to code duplication and just thinking of
having to add a new dependency to an object makes you groan in annoyance.</p>

<p>One solution to this problem is to write a factory to construct our objects for us.
This can remove all code duplication which makes changing dependencies easy again,
but it still leads to lots of brain dead code that we’d rather not write. In practice many
organizations end up forgoing their factories in favor of more dynamic dependency
injection frameworks that construct objects using reflection, like Spring or Guice.</p>

<h2 id="reader-monads">Reader monads</h2>
<p>One alternative way to solve the testability problem would be to introduce a 
container for all things we want to change when testing:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Env</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Stock</span> <span class="n">stock</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Bank</span> <span class="n">bank</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Mailer</span> <span class="n">mailer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Env</span><span class="o">(</span>
        <span class="nc">StockService</span> <span class="n">stock</span><span class="o">,</span>
        <span class="nc">BankService</span> <span class="n">bank</span><span class="o">,</span>
        <span class="nc">MailService</span> <span class="n">mailer</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stock</span> <span class="o">=</span> <span class="n">stock</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mailer</span> <span class="o">=</span> <span class="n">mailer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">acceptOrder</span><span class="o">(</span><span class="nc">Env</span> <span class="n">env</span><span class="o">,</span> <span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">totalCost</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">env</span><span class="o">.</span><span class="na">stock</span><span class="o">.</span><span class="na">reduceSupply</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">);</span>
        <span class="n">totalCost</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="na">cost</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="na">amount</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">env</span><span class="o">.</span><span class="na">bank</span><span class="o">.</span><span class="na">chargeMoney</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">customer</span><span class="o">,</span> <span class="n">totalCost</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">mailContents</span> <span class="o">=</span> <span class="n">formulateOrderAcceptedMail</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">mailer</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">customer</span><span class="o">,</span> <span class="n">mailContents</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Now we only had to construct objects for those services that we want to change
when testing. In this small example it didn’t have much effect on the code size
but in a large project it could remove a lot of useless objects. We could also put
regular function references instead of service objects into the <code class="highlighter-rouge">Env</code> if we’d prefer.
Finally, we could also remove the <code class="highlighter-rouge">Env</code> entirely and pass around the services one by one, but
this quickly leads to an unmaintainable mess.</p>

<p>Here we are looking up names in an environment which we got passed to us by our caller.
It should be even more obvious than with dependency injection that this is just dynamic scoping in disguise.</p>

<p>The problem with this style of programming is of course that we have to pass the <code class="highlighter-rouge">Env</code> around everywhere.
However, some programming languages –like Haskell– has syntactic sugar that lets us implicitly pass
the <code class="highlighter-rouge">Env</code> around: this is called using a reader monad.</p>

<h2 id="explicit-dynamic-scoping">Explicit dynamic scoping</h2>
<p>Some lexically scoped programming languages, like Perl and most Lisps, allow us to explicitly
declare that a certain name should be dynamically scoped. Let’s explore how that would be done
in Clojure.</p>

<p>First let’s define a dangerous function that we don’t want called in test:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">myproject.lib</span><span class="p">)</span><span class="w">

</span><span class="c1">; This defines send-nukes as dynamically scoped.</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="o">^</span><span class="no">:dynamic</span><span class="w"> </span><span class="n">send-nukes</span><span class="w">
  </span><span class="s">"Performs some side effect on the outside world. Should not be called in test."</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"This was bad. Really bad."</span><span class="p">))</span></code></pre></figure>

<p>Then let’s use it in two different ways:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">myproject.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">myproject.lib</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">lib</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">do-stuff</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">lib/send-nukes</span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="p">)</span><span class="w">

</span><span class="c1">; Normal usage</span><span class="w">
</span><span class="p">(</span><span class="nf">do-stuff</span><span class="w"> </span><span class="s">"hi"</span><span class="p">)</span><span class="w">
</span><span class="c1">; Safe testing</span><span class="w">
</span><span class="p">(</span><span class="nb">binding</span><span class="w"> </span><span class="p">[</span><span class="n">lib/send-nukes</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"No problem"</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-stuff</span><span class="w"> </span><span class="s">"hi"</span><span class="p">))</span></code></pre></figure>

<p>In my opinion this style of dependency injection is the simplest one. 
It’s a shame that it isn’t available in more languages.</p>

  </div>

  <div class="date">
    Written on October 26, 2019
  </div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          












        </footer>
      </div>
    </div>

  </body>
</html>
